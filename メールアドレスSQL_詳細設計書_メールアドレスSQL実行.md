## メールアドレスSQL実行		
プログラムID:dbpro04		
		
## 環境部		
### 入出力節		
ファイル管理段落		
・回答者ファイルを/home/suzuki/DATA/MAILADRESSとのファイルの対応を宣言する。		

・順ファイルの入出力状態(入力状態)を宣言する。		

・回答者最終ファイルを/home/suzuki/DATA/MAILADRESSFINALとのファイルの対応を宣言する。		

・順ファイルの入出力状態(出力状態)を宣言する。		

・属性ファイルを/home/suzuki/DATA/ZOKUSEIとのファイルの対応を宣言する。		

・順ファイルの入出力状態(属性状態)を宣言する。		
		
## データ部		
### ファイル節		
回答者ファイルをファイル節に記述する。		
集団項目(レベル番号01)		

|項目名|設定値|
|---|---|
|回答者レコード|-|	
		
基本項目(レベル番号05):CP009		
|項目名|桁数|備考|
|---|---|---|
|メールアドレス|30(Xタイプ)|---|	
|国名|20(Xタイプ)|-|	
|性別|1(Xタイプ)|-|	
|年齢|4(9タイプ)|-|	
		
回答者最終ファイルをファイル節に記述する。		

集団項目(レベル番号01)		

|項目名|設定値|	
|回答者最終レコード|-|	
		
基本項目(レベル番号05):CP009		

|項目名|桁数|備考|
|---|---|---|
|メールアドレス|30(Xタイプ)|	
|国名|20(Xタイプ)|	
|性別|1(Xタイプ)|	
|年齢|4(9タイプ)|	
		
属性ファイルをファイル節に記述する。		
集団項目(レベル番号01)		

|項目名|設定値|	
|属性レコード|-|	
		
基本項目(レベル番号05):CP010		

|項目名|桁数|備考|
|---|---|---|
|メールアドレス|30(Xタイプ)|-|	
|属性|10(Xタイプ)|-|
		
作業場所節		
集団項目(レベル番号01)		

|項目名|桁数|	
|状態|-|	
		
集団項目(レベル番号03)		
|項目名|桁数|	
|入力状態|2(Xタイプ)|	
|出力状態|2(Xタイプ)|	
		
### 1.ホスト変数の定義		
埋込SQL宣言節		
集団項目(レベル番号01)		

|項目名|桁数|設定値|
|---|---|---|
|DBNAME|10(Xタイプ)|mydb|
|USERNAME|10(Xタイプ)|suzuki|
|PASSWORD|10(Xタイプ)|yudai103|
		
集団項目(レベル番号01)		

|項目名|桁数|設定値|
|---|---|---|
|SW-AREA|-|-|
		
基本項目(レベル番号03)		

|項目名|桁数|設定値|
|---|---|---|
|SW-NOTFOUND|1(Xタイプ)|SPACE|
		
集団項目(レベル番号01)		

|項目名|桁数|設定値|
|---|---|---|
|CST-AREA|-|-|
		
基本項目(レベル番号03)		

|項目名|桁数|設定値|
|---|---|---|
|CST-1X|1(Xタイプ)|1|
|CST-SQL-NF|5(S9タイプ)|+100|
		
集団項目(レベル番号01)		

|項目名|設定値|
|---|---|
|WK-KAITOH１|-|	
		
基本項目(レベル番号03)		

|項目名|桁数|設定値|
|---|---|---|
|MAILADRESS１|30(Xタイプ)|-|
|KUNIMEI|20(Xタイプ)|-|
|SEIBETU|1(Xタイプ)|-|
|NENREI|4(9タイプ)|-|
		
集団項目(レベル番号01)		

|項目名|設定値|	
|WK-KAITOH２|-|	
		
基本項目(レベル番号03)		

|項目名|桁数|設定値|
|---|---|---|
|MAILADRESS２|30(Xタイプ)|-|
|ZOKUSEI|10(Xタイプ)|-|
		
### 2.共通領域の定義		
SQLCAをイクルードする。		
		
## 手続き部		
## KAISIセクション		
main		
		
### 3.ファイルOPEN		
回答者ファイルを入力ファイルで開く。		
回答者最終ファイルを出力ファイルで開く。		
・入力状態または出力状態または属性状態が 00の場合		
処理しない		
・それ以外の場合		
回答者ファイルを閉じる。		
回答者最終ファイルを閉じる。		
属性ファイルを閉じる。		
オープンエラー。		
プログラムを終了させる。		
		
### 4.データベースと接続		
USERNAMEとPASSWORDとDBNAMEで接続する。		
		
### 5.データベースアクセス		
全件削除		
kaitousyaテーブルを全件削除する。		
SQLコードを表示する。		
zokuseiテーブルを全件削除する。		
SQLコードを表示する。		
COMMITを実行する。		
DB ALL DELETE ENDが表示される。		
		
追加		
入力状態が00でなくなるまでループ処理をする。		
回答者ファイルを読み込む		
読み込み完了時		
READ ENDを表示する。		
		
読み込み時		
回答者レコードをWK-KAITOH１に設定する。		
シート：回答者ファイルをそれぞれ回答者テーブル(kaitousya)に追加する。		
※シート:別紙、回答者		
SQLコードを表示する。		
		
COMMITを実行する。		
		
READを抜けて、ループ処理を抜ける。		
		
DB INSERT ENDが表示される。		
		
更新		
回答者テーブルにkaitousyaにメールアドレスを基に、国名を登録する。		
アドレスの２文字が国コードであることを利用して国名列を更新する。		
１つのSQL文で全行更新する。		
国コードと国名の次のように対応している。		
jp：日本　uk：イギリス　cn：中国		
fr：フランス vn：ベトナム		
		
SQLコードを表示する。		
		
		
メールアドレス、年齢、性別を属性テーブル(zokusei)に追加する。		
メールアドレスは余分な空白は除去する。		
性別と年齢で1つの項目とし、年齢は年代として次の様に表示する。		
ただし、20～50代のみ考慮すればいい。		
例)50代:男性		
なお、性別はMが男性、Fが女性を表している。		
		
SQLコードを表示する。		
		
DB UPDATE ENDが表示される。		
		
COMMITを実行する。		
		
## 6.カーソルオープン処理(OPEN-RTN)		
カーソルオープン処理を表示する。		
カーソル名CSR00で回答者テーブル(kaitousya)をすべての列に対してSELECT文を定義する。		
カーソル名CSR01で属性テーブル(zokusei)をすべての列に対してSELECT文を定義する。		
カーソル名CSR00を開く。		
カーソル名CSR01を開く。		
		
## 7.FETCH処理1(FETCH-RTN1)		
FETCH-RTNに対して、SW-NOTFOUND = CST-1Xになるまでループ処理を繰り返す		
FETCH処理1を表示する。		
WK-KAITOH１に対してカーソル名CSR00でフェッチ文を実行する。		
SQLCODE = CST-SQL-NFの時		
CST-1XをSW-NOTFOUNDに設定する。		
SQLCODEを表示する。		
		
SQLCODE = CST-SQL-NF以外の時		
メールアドレス:MAILADRESS１、国名:KUNIMEI、性別:SEIBETU、年齢:NENREIを表示する。		
WK-KAITOH１を回答者最終レコードに設定する。		
回答者最終レコードに書き込む。		
回答者最終ファイル出力を表示する。		
		
## 8.FETCH処理1(FETCH-RTN2)		
SW-NOTFOUNDを初期化する。		
FETCH-RTNに対して、SW-NOTFOUND = CST-1Xになるまでループ処理を繰り返す		
FETCH処理2を表示する。		
WK-KAITOH１に対してカーソル名CSR01でフェッチ文を実行する。		
SQLCODE = CST-SQL-NFの時		
CST-1XをSW-NOTFOUNDに設定する。		
SQLCODEを表示する。		
		
SQLCODE = CST-SQL-NF以外の時		
メールアドレス:MAILADRESS２、属性:ZOKUSEIを表示する。		
WK-KAITOH２を属性レコードに設定する。		
属性レコードに書き込む。		
属性ファイル出力を表示する。		
		
## 9.カーソルクローズ処理(CLOSE-RTN)		
カーソルクローズ処理とファイルクローズ処理を表示する。		
カーソル名CSR00をクローズ処理する。		
カーソル名CSR01をクローズ処理する。		
回答者ファイルを閉じる。		
回答者最終ファイルを閉じる。		
属性ファイルを閉じる。		
		
## 9.プログラム終了(PROEND)		
プログラムを終了する。		
